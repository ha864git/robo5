<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Web BLE Bipedal Control Panel</title>
</head>

<style>
    #tabcontrol a {
        display: inline-block;
        border-width: 1px 1px 0px 1px;
        border-style: solid;
        border-color: black;
        border-radius: 0.75em 0.75em 0 0;
        padding: 0.75em 1em;
        text-decoration: none;
        color: black;
        background-color: white;
        font-weight: bold;
        position: relative;
        margin-block-end: -1em;
    }

    #tabcontrol a:hover {
        text-decoration: underline;
    }

    #tabbody .pages {
        width: 325px;
        height: 510px;
        border: 1px solid black;
        margin-top: -1px;
        padding: 1em;
        background-color: white;
        position: relative;
        z-index: 0;
    }

    #tabcontrol a:nth-child(1),
    #tabbody div:nth-child(1).pages {
        background-color: #ffffdd;
    }

    #tabcontrol a:nth-child(2),
    #tabbody div:nth-child(2).pages {
        background-color: #ddffdd;
    }

    #tabcontrol a:nth-child(3),
    #tabbody div:nth-child(3).pages {
        background-color: #ddddff;
    }

    .connect-state {
        display: flex;
    }

    .connect-btn {
        width: 140px;
        height: 35px;
        border-radius: 8px;
        font-size: 14pt;
        background-color: blue;
        color: white;
    }

    .display-none {
        display: none;
    }




    #ws {
        flex: 1 1 320px;
        display: flex;
        justify-content: center;
        /* 水平方向中央 */
        align-items: flex-start;
        /* 上揃え（必要なら center に変更） */
        min-width: 260px;
        box-sizing: border-box;
    }

    .ctrl_container {
        display: flex;
        flex-direction: row;
    }

    .inner_container {
        margin-left: 0px;
        margin-right: 10px;
    }

    input.range {
        width: 154px;
    }

    input.ra {
        width: 100px;
    }

    .range_btn {
        width: 26px;
        height: 26px;
        border-radius: 13px;
        font-size: 14pt;
        background-color: lightgray;
        color: black;
        border: none;
    }

    .lineset {
        margin: 10px;
        padding: 10px;
        border: 2px solid #000000;
        border-radius: 10px;
    }

    .range_set {
        margin-top: 10px;
        margin-bottom: 10px;

    }

    .tit {
        width: 80px;
        text-align: center;
    }

    .tit.lft {
        background: skyblue;
        color: white;
    }

    .tit.rit {
        background: coral;
        color: black;
    }

    .setang {
        margin-left: 120px;
        margin-top: 20px;
    }

    .update {
        width: 90px;
        height: 35px;
        border-radius: 8px;
        font-size: 10pt;
        background-color: black;
        color: white;
    }

    input.range {
        width: 154px;
    }

    td {
        text-align: center;
    }

    td.left {
        background-color: skyblue;
    }

    td.right {
        background-color: coral;
    }

    th {
        background-color: lightgrey;
        height: 50px;
    }

    .mbutton {
        width: 200px;
        height: 35px;
        border-radius: 8px;
        font-size: 10pt;
        background-color: black;
        color: white;
        margin-top: 5px;
    }
</style>

<body>
    <div class="connect-state">
        <button class="connect-btn" type="button" id="connect-BleButton">connect</button>
    </div>
    <p id="tabcontrol">
        <a href="#tabpage1">PANEL</a>
        <a href="#tabpage2">DIRECT</a>
        <a href="#tabpage3">ADJUST</a>
    </p>
    <div id="tabbody">
        <div class="pages" id="tabpage1">
            <div>
                <button type="button" id="btn_fileopen">file</button>
                <input type="text" id="txtFileName" name="value1" value="" size="15" />
                <input type="text" id="txtlen" name="value2" value="" size="6" />
                <button type="button" id="btn_upload">upload</button>
            </div>
            <input type="file" id="fileinput" accept=".py" style="display:none">
            <div>
                <button type="button" id="btn_makelist">list</button>
            </div>
            <div id="result"></div>
        </div>
        <div class="pages" id="tabpage2">
            <div id="ws">
                <div class="inner_containerz">
                    <div class="ctrl_container">
                        <label class="tit lft" for="number_bd">WS</label>
                        <input class="na" type="text" id="number_bd" name="number_bd" autocomplete="off" size="6" />
                    </div>
                    <div class="ctrl_container range_set">
                        <input class="range_btn" id="range_btn_inc_bd" type="button" value="+">
                        <input class="ra" type="range" id="range_bd" min="-80" max="80" value="0" aria-label="range_fr"
                            onchange="range2number('bd')">
                        <input class="range_btn" id="range_btn_dec_bd" type="button" value="-">
                    </div>
                </div>
            </div>
            <div class="ctrl_container">
                <div class="inner_container">
                    <div class="ctrl_container">
                        <label class="tit lft" for="number_fl">HL</label>
                        <input class="na" type="text" id="number_fl" name="number_fl" autocomplete="off" size="6" />
                    </div>
                    <div class="ctrl_container range_set">
                        <input class="range_btn" id="range_btn_inc_fl" type="button" value="+">
                        <input class="ra" type="range" id="range_fl" min="-80" max="80" value="0" aria-label="range_fr"
                            onchange="range2number('fl')">
                        <input class="range_btn" id="range_btn_dec_fl" type="button" value="-">
                    </div>
                    <div class="ctrl_container">
                        <label class="tit lft" for="number_hl">KL</label>
                        <input class="na" type="text" id="number_hl" name="number_hl" autocomplete="off" size="6" />
                    </div>
                    <div class="ctrl_container range_set">
                        <input class="range_btn" id="range_btn_inc_hl" type="button" value="+">
                        <input class="ra" type="range" id="range_hl" min="-80" max="80" value="0" aria-label="range_fr"
                            onchange="range2number('hl')">
                        <input class="range_btn" id="range_btn_dec_hl" type="button" value="-">
                    </div>
                </div>
                <div class="inner_container">
                    <div class="ctrl_container">
                        <label class="tit rit" for="number_fr">HR</label>
                        <input class="na" type="text" id="number_fr" name="number_fr" autocomplete="off" size="6" />
                    </div>
                    <div class="ctrl_container range_set">
                        <input class="range_btn" id="range_btn_inc_fr" type="button" value="+">
                        <input class="ra" type="range" id="range_fr" min="-80" max="80" value="0" aria-label="range_fr"
                            onchange="range2number('fr')">
                        <input class="range_btn" id="range_btn_dec_fr" type="button" value="-">
                    </div>
                    <div class="ctrl_container">
                        <label class="tit rit" for="number_hr">KR</label>
                        <input class="na" type="text" id="number_hr" name="number_hr" autocomplete="off" size="6" />
                    </div>
                    <div class="ctrl_container range_set">
                        <input class="range_btn" id="range_btn_inc_hr" type="button" value="+">
                        <input class="ra" type="range" id="range_hr" min="-80" max="80" value="0" aria-label="range_fr"
                            onchange="range2number('hr')">
                        <input class="range_btn" id="range_btn_dec_hr" type="button" value="-">
                    </div>
                </div>
            </div>
            <div class="inner_container">
                <div class="ctrl_container">
                    <input class="update setang" type="button" value="UPDATE" onclick="set_angles()">
                </div>
            </div>
        </div>
        <div class="pages" id="tabpage3">
            <datalist id="my-datalist">
                <option value="80"></option>
                <option value="81"></option>
                <option value="82"></option>
                <option value="83"></option>
                <option value="84"></option>
                <option value="85"></option>
                <option value="86"></option>s
                <option value="87"></option>
                <option value="88"></option>
                <option value="89"></option>
                <!---- for center mark -----
                <option value="90"></option>
                --------------------------->
                <option value="91"></option>
                <option value="92"></option>
                <option value="93"></option>
                <option value="94"></option>
                <option value="95"></option>
                <option value="96"></option>
                <option value="97"></option>
                <option value="98"></option>
                <option value="99"></option>
                <option value="100"></option>
            </datalist>
            <table id="adjust-table" class="display-none">
                <tr>
                    <th class="side" colspan="2">Body</th>
                </tr>
                <tr>
                    <td colspan="2"><input type="range" class="range" list="my-datalist" id="bd_ini" min="80" max="100"
                            value="90" aria-label="bd_ini"></td>
                </tr>
                <tr>
                    <th class="side" colspan="2">Legs</th>
                </tr>
                <tr>
                    <td class="left">Left</td>
                    <td class="right">Right</td>
                </tr>
                <tr>
                    <td><input type="range" class="range" list="my-datalist" id="fl_ini" min="80" max="100" value="90"
                            aria-label="fl_ini"></td>
                    <td><input type="range" class="range" list="my-datalist" id="fr_ini" min="80" max="100" value="90"
                            aria-label="fr_ini"></td>
                </tr>
                <tr>
                    <td><input type="range" class="range" list="my-datalist" id="hl_ini" min="80" max="100" value="90"
                            aria-label="hl_ini"></td>
                    <td><input type="range" class="range" list="my-datalist" id="hr_ini" min="80" max="100" value="90"
                            aria-label="hr_ini"></td>
                </tr>
                <tr>
                    <th colspan="2"><button class="update" type="button" onclick="set_angles_ini()" />UPDATE</th>
                </tr>
            </table>
        </div>
    </div>

    <script>

        let timeoutID = null;

        const UUID_UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e'
        const UUID_RX_CHAR_CHARACTERISTIC = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'
        const UUID_TX_CHAR_CHARACTERISTIC = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'

        let options = {
            filters: [
                { services: [UUID_UART_SERVICE] },
                { namePrefix: "mpy-uart" },
            ],
        };

        let bluetoothDevice;
        let tx_characteristic;
        let rx_characteristic;

        // Connect Button (search for BLE Devices only if BLE is available)
        document.getElementById('connect-BleButton').addEventListener('click', (event) => {
            if (isWebBluetoothEnabled() && !bluetoothDevice) {
                document.getElementById('connect-BleButton').innerHTML = "connecting";
                connectToDevice();
            }
        });

        // Check if BLE is available in your Browser
        function isWebBluetoothEnabled() {
            if (!navigator.bluetooth) {
                console.log("Web Bluetooth API is not available in this browser!");
                document.getElementById('connect-BleButton').innerHTML = "not available";
                return false
            }
            console.log('Web Bluetooth API supported in this browser.');
            return true
        }

        // Connect to BLE Device and Enable Notifications
        function connectToDevice() {
            console.log('Initializing Bluetooth...');
            navigator.bluetooth.requestDevice(options)
                .then(device => {
                    bluetoothDevice = device;
                    console.log('Device Selected:', device.name);
                    // Set up event listener for when device gets disconnected.
                    device.addEventListener('gattserverdisconnected', onDisconnected);
                    return device.gatt.connect();
                })
                .then(gattServer => {
                    bleServer = gattServer;
                    console.log("Connected to GATT Server");
                    return bleServer.getPrimaryService(UUID_UART_SERVICE);
                })
                .then(service => {
                    bleServiceFound = service;
                    console.log("Service discovered:", service.uuid);
                    return Promise.all([
                        service.getCharacteristic(UUID_TX_CHAR_CHARACTERISTIC),
                        service.getCharacteristic(UUID_RX_CHAR_CHARACTERISTIC)
                    ]);
                })
                .then(characteristic => {
                    console.log("Characteristic discovered:", characteristic);
                    tx_characteristic = characteristic[0];
                    tx_characteristic.startNotifications();
                    console.log("Notifications Started.");
                    tx_characteristic.addEventListener('characteristicvaluechanged', onCharacteristicValueChanged);
                    rx_characteristic = characteristic[1];
                    document.getElementById('connect-BleButton').innerHTML = "Connected";
                    send_message('get angles_init');
                })
                .catch(error => {
                    console.log('Error: ', error);
                    document.getElementById('connect-BleButton').innerHTML = "Connect";
                })
        }

        function onDisconnected(event) {
            const device = event.target;
            console.log(`Device ${device.name} is disconnected.`);
            bluetoothDevice = null;
            document.getElementById('connect-BleButton').innerHTML = "Connect";
            //    radio_display_init();
        }

        // Receive messages from picoW
        function onCharacteristicValueChanged(e) {
            let str_arr = [];
            for (let i = 0; i < this.value.byteLength; i++) {
                str_arr[i] = this.value.getUint8(i);
            }
            let str = String.fromCharCode.apply(null, str_arr);
            check_rx_data(str);
        }

        let tx_buffer = [];

        // Send message
        function send_message(message) {
            if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !rx_characteristic) {
                alert('Please connect.');
                return;
            }
            let ArrayBuffer = new TextEncoder().encode(message + '\n');
            rx_characteristic.writeValueWithResponse(ArrayBuffer)
                .then(ans => {
                    if (tx_buffer.length > 0) {
                        // Retrieve and send data that could not be sent
                        let ArrayBuffer2 = tx_buffer.pop();
                        rx_characteristic.writeValueWithoutResponse(ArrayBuffer2);
                    }
                })
                .catch(error => {
                    // Save data that could not be sent
                    tx_buffer.unshift(ArrayBuffer);
                });
        }

        // アップロード用タイムアウト管理
        let uploadTimeout = null;
        const UPLOAD_TIMEOUT_MS = 1000; // 1秒

        // タイムアウトタイマーをセットする関数
        function setUploadTimeout() {
            // 既存のタイマーをクリア
            clearUploadTimeout();

            uploadTimeout = setTimeout(() => {
                console.error('Upload timeout: 次の受信がありません');
                document.querySelector('#txtlen').value = 'err:Timeout';
                uploading = false;
                uploadTimeout = null;
            }, UPLOAD_TIMEOUT_MS);
        }

        // タイムアウトタイマーをクリアする関数
        function clearUploadTimeout() {
            if (uploadTimeout !== null) {
                clearTimeout(uploadTimeout);
                uploadTimeout = null;
            }
        }

        let uploading = false;
        let upload_line = 0;
        let upload_data = [];
        let latest_chunk = "";

        function Upload() {
            if (upload_data.length < 1) {
                alert('No data to upload. Please select a file first.');
                return;
            }
            uploading = true;
            upload_line = 0;
            let chunk = 'm' + ('000' + upload_line).slice(-3) + upload_data[upload_line];
            latest_chunk = chunk;
            send_message(chunk);
            setUploadTimeout(); // タイムアウトをセット
        }

        function check_rx_data(str) {
            console.log(str);
            if (str.length > 1) {
                if (str[0] === 'm' && uploading) {
                    clearUploadTimeout(); // 受信時にタイムアウトをクリア
                    if (str === latest_chunk) {
                        if (upload_line < upload_data.length) {
                            upload_line += 1;
                            document.querySelector('#txtlen').value = `${upload_line}/${upload_data.length}`;
                            let chunk = 'mend';
                            if (upload_line < upload_data.length) {
                                chunk = 'm' + ('000' + upload_line).slice(-3) + upload_data[upload_line];
                            }
                            latest_chunk = chunk;
                            send_message(chunk);
                            setUploadTimeout(); // タイムアウトをセット
                        } else {
                            // Upload complete
                            document.querySelector('#txtlen').value = 'complete';
                            uploading = false;
                            console.log('Upload complete.');
                        }
                    } else {
                        let chunk = 'm' + 'err';
                        latest_chunk = chunk;
                        console.log('Uploading line:', upload_line, '/', chunk);
                        send_message(chunk);
                    }
                    return;
                }
            }
            let args = str.split(' ');
            if (args.length == 2) {
                paras = args[1].split(',');
                if (args[0] === 'ri') {
                    document.getElementById("fr_ini").value = 180 - parseInt(paras[0]);
                    document.getElementById("hr_ini").value = 180 - parseInt(paras[1]);
                    document.getElementById("fl_ini").value = parseInt(paras[2]);
                    document.getElementById("hl_ini").value = parseInt(paras[3]);
                    document.getElementById("bd_ini").value = parseInt(paras[4]);
                    document.getElementById("adjust-table").classList.remove('display-none');
                } else if (args[0] === 'ra') {
                    document.getElementById("number_fr").value = parseInt(paras[0]) - 90;
                    document.getElementById("number_hr").value = parseInt(paras[1]) - 90;
                    document.getElementById("number_fl").value = 90 - parseInt(paras[2]);
                    document.getElementById("number_hl").value = 90 - parseInt(paras[3]);
                    document.getElementById("number_bd").value = parseInt(paras[4]) - 90;
                    const legs = ["fr", "hr", "fl", "hl", "bd"];
                    legs.forEach(function (element) {
                        number2range(element)
                    });
                } else if (args[0] === 'rm') {
                    console.log('set motion list', paras);
                    if (paras[0] === 'end') {
                        console.log('motion list end');
                        addEvent_to_motion_buttons();
                    } else {
                        let num = parseInt(paras[0]);
                        send_message(`get_motion ${num + 1}`);
                        append_list(paras[1], paras[2]);
                    }
                }
            }
        }

        function set_angles_ini() {
            const fr_ini = 180 - document.getElementById("fr_ini").value;
            const hr_ini = 180 - document.getElementById("hr_ini").value;
            const fl_ini = document.getElementById("fl_ini").value;
            const hl_ini = document.getElementById("hl_ini").value;
            const bd_ini = document.getElementById("bd_ini").value;
            let tx_str = "si " + fr_ini + "," + hr_ini + "," + fl_ini + "," + hl_ini + "," + bd_ini;
            send_message(tx_str);
        }

        function set_angles() {
            const fr = parseInt(document.getElementById("number_fr").value);
            const hr = parseInt(document.getElementById("number_hr").value);
            const fl = parseInt(document.getElementById("number_fl").value);
            const hl = parseInt(document.getElementById("number_hl").value);
            const bd = parseInt(document.getElementById("number_bd").value);
            const tx_str = "sa " + fr + "," + hr + "," + fl + "," + hl + "," + bd;
            send_message(tx_str);
        }

        function direct_button_addEvens() {
            const legs = ["fr", "hr", "fl", "hl", "bd"];
            legs.forEach(function (element) {
                document.getElementById("number_" + element).addEventListener("focusout", (event) => {
                    event.target.value = check_num(event.target.value);
                    number2range(element);
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("mousedown", () => {
                    event.preventDefault();
                    timerset_inc(element);
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("touchstart", () => {
                    event.preventDefault();
                    timerset_inc(element);
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("mouseup", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("touchend", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("mouseout", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_inc_" + element).addEventListener("touchcancel", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("mousedown", () => {
                    event.preventDefault();
                    timerset_dec(element);
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("touchstart", () => {
                    event.preventDefault();
                    timerset_dec(element);
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("mouseup", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("touchend", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("mouseout", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
                document.getElementById("range_btn_dec_" + element).addEventListener("touchcancel", () => {
                    event.preventDefault();
                    clearRepeatBtn();
                });
            });
        }
        direct_button_addEvens();

        document.querySelector('#btn_fileopen').addEventListener('click', () => {
            document.getElementById("fileinput").click();
        });
        document.getElementById('fileinput').addEventListener('click', clearFilePath);
        function clearFilePath(e) { this.value = null; }
        document.getElementById('fileinput').addEventListener('change', fileInput);

        document.querySelector('#btn_makelist').addEventListener('click', () => {
            make_list();
        });

        let motion_list = [];

        function make_list() {
            send_message('get_motion 0');
            motion_list = [];
        }

        function append_list(name, mode) {
            motion_list.push({ 'name': name, 'mode': mode });
            let result_div = document.getElementById('result');
            result_div.innerHTML = '';
            motion_list.forEach(function (item, index) {
                result_div.innerHTML += `<button type="button" id="btn_m${index}" class="mbutton">${item.name}</button><br>`;
            });
        }

        function addEvent_to_motion_buttons() {
            motion_list.forEach(function (item, index) {
                const elmnt = document.getElementById(`btn_m${index}`);
                elmnt.addEventListener('mousedown', () => {
                    send_message(`${motion_list[index].name}`);
                });
                elmnt.addEventListener('touchstart', () => {
                    send_message(`${motion_list[index].name}`);
                });
                if (motion_list[index].mode !== 's') {
                    elmnt.addEventListener("mouseup", () => {
                        send_message('stop');
                    });
                    elmnt.addEventListener("touchend", () => {
                        send_message('stop');
                    });
                }
            });
        }

        function fileInput(e) {
            const files = e.target.files;
            document.querySelector('#txtFileName').value = files[0].name;
            const result = e.target.files[0];
            const reader = new FileReader();
            reader.readAsText(result);

            // ASCII 判定ヘルパー（タブ/改行/復帰は許可、その他は 32-126 の印字可能文字）
            function isAsciiString(s) {
                for (let i = 0; i < s.length; i++) {
                    const code = s.charCodeAt(i);
                    if (!(code === 9 || code === 10 || code === 13 || (code >= 32 && code <= 126))) {
                        return false;
                    }
                }
                return true;
            }

            reader.addEventListener('load', function (ev) {
                const text = ev.target.result;
                if (typeof text !== 'string') {
                    alert('読み込んだ内容が文字列ではありません。');
                    return;
                }
                if (!isAsciiString(text)) {
                    alert('ファイルにASCII外の文字が含まれています。処理を中止します。');
                    console.warn('非ASCII文字検出:', text);
                    return;
                }

                // 改行を '\n' に統一 さらに '\n' を文字列 '\\n' に変換
                const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n/g, '\\n');

                // 15文字ごとに分割して配列に格納
                upload_data = [];
                for (let i = 0; i < normalized.length; i += 15) {
                    upload_data.push(normalized.slice(i, i + 15));
                }
                upload_line = 0;

                console.log('upload_data 準備完了, チャンク数:', upload_data.length);
                document.getElementById('connect-BleButton').innerHTML = "Connect";
                document.querySelector('#txtlen').value = `0/${upload_data.length}`;
            });

            reader.addEventListener('error', function (err) {
                console.error('FileReader error', err);
                alert('ファイルの読み込み中にエラーが発生しました。');
            });
        }
        document.querySelector('#btn_upload').addEventListener('click', () => {
            if (uploading) {
                alert('Uploading now. Please wait.');
                return;
            }
            Upload();
        });

        function number2range(w) {
            let ang = parseInt(document.getElementById("number_" + w).value);
            ang = 0 - ang;
            document.getElementById("range_" + w).value = ang;
        }

        function range2number(w) {
            let ang = parseInt(document.getElementById("range_" + w).value);
            document.getElementById("number_" + w).value = 0 - ang;
        }

        function check_num(input_str) {
            let input_value = parseInt(input_str);
            if (input_value < -80) {
                input_value = -80;
            } else if (input_value > 80) {
                input_value = 80;
            } else if (isNaN(input_value)) {
                input_value = 0;
            }
            return input_value;
        }

        function inc_tover_next(leg) {
            timeoutID = setTimeout(function () {
                anginc(leg);
                inc_tover_next(leg);
            }, 50);
        }

        function timerset_inc(leg) {
            anginc(leg);
            timeoutID = setTimeout(function () {
                anginc(leg);
                inc_tover_next(leg);
            }, 600);
        }

        function dec_tover_next(leg) {
            timeoutID = setTimeout(function () {
                angdec(leg);
                dec_tover_next(leg);
            }, 50);
        }

        function timerset_dec(leg) {
            angdec(leg);
            timeoutID = setTimeout(function () {
                angdec(leg);
                dec_tover_next(leg);
            }, 600);
        }

        function clearRepeatBtn() {
            clearTimeout(timeoutID);
        }

        function anginc(w) {
            const elm = document.getElementById("number_" + w);
            val = parseInt(elm.value);
            if (isNaN(val)) { val = 0; }
            if (val >= 80) {
                val = 80 - 1;
            } else if (val < -80) {
                val = -80;
            }
            val += 1;
            elm.value = val;
            number2range(w);
        }

        function angdec(w) {
            const elm = document.getElementById("number_" + w);
            val = parseInt(elm.value);
            if (isNaN(val)) { val = 0; }
            if (val > 80) {
                val = 80;
            } else if (val <= -80) {
                val = -80 + 1;
            }
            val -= 1;
            elm.value = val;
            number2range(w);
        }

        let tabs = document.getElementById('tabcontrol').getElementsByTagName('a');
        const pages = document.getElementsByClassName('pages');

        function changeTab() {
            let targetid = this.href.substring(this.href.indexOf('#') + 1, this.href.length);

            for (let i = 0; i < pages.length; i++) {
                if (pages[i].id != targetid) {
                    pages[i].style.display = "none";
                }
                else {
                    pages[i].style.display = "block";
                }
            }

            for (let i = 0; i < tabs.length; i++) {
                tabs[i].style.zIndex = "0";
            }
            this.style.zIndex = "10";

            if (targetid === "tabpage2") {
                send_message('get angles');
            } else if (targetid === "tabpage3") {
                send_message('sa 0,0,0,0,0');
            } else if (targetid === "tabpage1") {
                //send_message('stop');
            }

            return false;
        }

        for (let i = 0; i < tabs.length; i++) {
            tabs[i].onclick = changeTab;
        }

        tabs[0].onclick();

    </script>

</body>

</html>